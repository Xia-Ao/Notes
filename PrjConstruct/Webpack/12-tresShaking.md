

TerserWebpackPlugin

[treeShaking官方文档](https://webpack.docschina.org/guides/tree-shaking/)

源码疑似位置：`lib/dependencies/HarmonyModulesPlugin.js`， 会将多余代码标记出来。

```js
/* 1 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {
  'use strict';
  /* unused harmony export square */
  /* harmony export (immutable) */ __webpack_exports__['a'] = cube;
  function square(x) {
    return x * x;
  }

  function cube(x) {
    return x * x * x;
  }
});
```
在上述打包文件中，`unused harmony export square`注释代码下放就是没有引用的代码块。

删除多余代码在uglifyJS中执行，webpack中使用`TerserWebpackPlugin`执行代码压缩。




我们主要讲一下treeShaking的基本原理和treeShaking的价值。

在用treeShaking的工具目前主流有 rollup，webpack，closure compiler（google）。

在[这里](https://juejin.im/post/5a4dc842518825698e7279a9)， 有人对三大工具treeShaking效果进行了对比。

结论如下：

- ES6的模块引入是静态分析的，故而可以在编译时正确判断到底加载了什么代码。
- 分析程序流，判断哪些变量未被使用、引用，进而删除此代码。


理想是美好的，当现实是骨感的，实际执行treeShaking效果并不好，原因在于副作用。

#### 副作用
一个函数会、或者可能会对函数外部变量产生影响的行为。

```js
function go (url) {
  window.location.href = url
}
```

具体的案例可以戳这里：[传送门](https://zhuanlan.zhihu.com/p/32831172)


rollup ES6：[传送门](https://rollupjs.cn/repl?version=0.53.3&shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMEFwcGxlJTIwJTdEJTIwZnJvbSUyMCcuJTJGY29tcG9uZW50cyclNUNuJTVDbmNvbnN0JTIwYXBwbGVNb2RlbCUyMCUzRCUyMG5ldyUyMEFwcGxlKCU3QiU1Q24lMjAlMjBtb2RlbCUzQSUyMCdJcGhvbmVYJyU1Q24lN0QpLmdldE1vZGVsKCklNUNuJTVDbmNvbnNvbGUubG9nKGFwcGxlTW9kZWwpJTIyJTdEJTJDJTdCJTIybmFtZSUyMiUzQSUyMmNvbXBvbmVudHMuanMlMjIlMkMlMjJjb2RlJTIyJTNBJTIyZXhwb3J0JTIwY2xhc3MlMjBQZXJzb24lMjAlN0IlNUNuJTIwJTIwY29uc3RydWN0b3IlMjAoJTdCJTIwbmFtZSUyQyUyMGFnZSUyQyUyMHNleCUyMCU3RCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5jbGFzc05hbWUlMjAlM0QlMjAnUGVyc29uJyU1Q24lMjAlMjAlMjAlMjB0aGlzLm5hbWUlMjAlM0QlMjBuYW1lJTVDbiUyMCUyMCUyMCUyMHRoaXMuYWdlJTIwJTNEJTIwYWdlJTVDbiUyMCUyMCUyMCUyMHRoaXMuc2V4JTIwJTNEJTIwc2V4JTVDbiUyMCUyMCU3RCU1Q24lMjAlMjBnZXROYW1lJTIwKCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwcmV0dXJuJTIwdGhpcy5uYW1lJTVDbiUyMCUyMCU3RCU1Q24lN0QlNUNuZXhwb3J0JTIwY2xhc3MlMjBBcHBsZSUyMCU3QiU1Q24lMjAlMjBjb25zdHJ1Y3RvciUyMCglN0IlMjBtb2RlbCUyMCU3RCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5jbGFzc05hbWUlMjAlM0QlMjAnQXBwbGUnJTVDbiUyMCUyMCUyMCUyMHRoaXMubW9kZWwlMjAlM0QlMjBtb2RlbCU1Q24lMjAlMjAlN0QlNUNuJTIwJTIwZ2V0TW9kZWwlMjAoKSUyMCU3QiU1Q24lMjAlMjAlMjAlMjByZXR1cm4lMjB0aGlzLm1vZGVsJTVDbiUyMCUyMCU3RCU1Q24lN0QlMjIlN0QlNUQlMkMlMjJvcHRpb25zJTIyJTNBJTdCJTIyZm9ybWF0JTIyJTNBJTIyZXMlMjIlMkMlMjJtb2R1bGVOYW1lJTIyJTNBJTIybXlCdW5kbGUlMjIlMkMlMjJnbG9iYWxzJTIyJTNBJTdCJTdEJTJDJTIybmFtZSUyMiUzQSUyMm15QnVuZGxlJTIyJTJDJTIyYW1kJTIyJTNBJTdCJTIyaWQlMjIlM0ElMjIlMjIlN0QlN0QlMkMlMjJleGFtcGxlJTIyJTNBbnVsbCU3RA==)

rollup babel之后的代码：[传送门](https://rollupjs.cn/repl?version=0.53.3&shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMEFwcGxlJTIwJTdEJTIwZnJvbSUyMCcuJTJGY29tcG9uZW50cyclNUNuJTVDbmNvbnN0JTIwYXBwbGVNb2RlbCUyMCUzRCUyMG5ldyUyMEFwcGxlKCU3QiU1Q24lMjAlMjBtb2RlbCUzQSUyMCdJcGhvbmVYJyU1Q24lN0QpLmdldE1vZGVsKCklNUNuJTVDbmNvbnNvbGUubG9nKGFwcGxlTW9kZWwpJTIyJTdEJTJDJTdCJTIybmFtZSUyMiUzQSUyMmNvbXBvbmVudHMuanMlMjIlMkMlMjJjb2RlJTIyJTNBJTIydmFyJTIwX2NyZWF0ZUNsYXNzJTIwJTNEJTIwZnVuY3Rpb24lMjAoKSUyMCU3QiUyMGZ1bmN0aW9uJTIwZGVmaW5lUHJvcGVydGllcyh0YXJnZXQlMkMlMjBwcm9wcyklMjAlN0IlMjBmb3IlMjAodmFyJTIwaSUyMCUzRCUyMDAlM0IlMjBpJTIwJTNDJTIwcHJvcHMubGVuZ3RoJTNCJTIwaSUyQiUyQiklMjAlN0IlMjB2YXIlMjBkZXNjcmlwdG9yJTIwJTNEJTIwcHJvcHMlNUJpJTVEJTNCJTIwZGVzY3JpcHRvci5lbnVtZXJhYmxlJTIwJTNEJTIwZGVzY3JpcHRvci5lbnVtZXJhYmxlJTIwJTdDJTdDJTIwZmFsc2UlM0IlMjBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSUyMCUzRCUyMHRydWUlM0IlMjBpZiUyMCglNUMlMjJ2YWx1ZSU1QyUyMiUyMGluJTIwZGVzY3JpcHRvciklMjBkZXNjcmlwdG9yLndyaXRhYmxlJTIwJTNEJTIwdHJ1ZSUzQiUyME9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQlMkMlMjBkZXNjcmlwdG9yLmtleSUyQyUyMGRlc2NyaXB0b3IpJTNCJTIwJTdEJTIwJTdEJTIwcmV0dXJuJTIwZnVuY3Rpb24lMjAoQ29uc3RydWN0b3IlMkMlMjBwcm90b1Byb3BzJTJDJTIwc3RhdGljUHJvcHMpJTIwJTdCJTIwaWYlMjAocHJvdG9Qcm9wcyklMjBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSUyQyUyMHByb3RvUHJvcHMpJTNCJTIwaWYlMjAoc3RhdGljUHJvcHMpJTIwZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3RvciUyQyUyMHN0YXRpY1Byb3BzKSUzQiUyMHJldHVybiUyMENvbnN0cnVjdG9yJTNCJTIwJTdEJTNCJTIwJTdEKCklM0IlNUNuJTVDbmZ1bmN0aW9uJTIwX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlJTJDJTIwQ29uc3RydWN0b3IpJTIwJTdCJTIwaWYlMjAoIShpbnN0YW5jZSUyMGluc3RhbmNlb2YlMjBDb25zdHJ1Y3RvcikpJTIwJTdCJTIwdGhyb3clMjBuZXclMjBUeXBlRXJyb3IoJTVDJTIyQ2Fubm90JTIwY2FsbCUyMGElMjBjbGFzcyUyMGFzJTIwYSUyMGZ1bmN0aW9uJTVDJTIyKSUzQiUyMCU3RCUyMCU3RCU1Q24lNUNudmFyJTIwUGVyc29uJTIwJTNEJTIwZnVuY3Rpb24lMjAoKSUyMCU3QiU1Q24lMjAlMjBmdW5jdGlvbiUyMFBlcnNvbihfcmVmKSUyMCU3QiU1Q24lMjAlMjAlMjAlMjB2YXIlMjBuYW1lJTIwJTNEJTIwX3JlZi5uYW1lJTJDJTVDbiUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGFnZSUyMCUzRCUyMF9yZWYuYWdlJTJDJTVDbiUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNleCUyMCUzRCUyMF9yZWYuc2V4JTNCJTVDbiU1Q24lMjAlMjAlMjAlMjBfY2xhc3NDYWxsQ2hlY2sodGhpcyUyQyUyMFBlcnNvbiklM0IlNUNuJTVDbiUyMCUyMCUyMCUyMHRoaXMuY2xhc3NOYW1lJTIwJTNEJTIwJ1BlcnNvbiclM0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5uYW1lJTIwJTNEJTIwbmFtZSUzQiU1Q24lMjAlMjAlMjAlMjB0aGlzLmFnZSUyMCUzRCUyMGFnZSUzQiU1Q24lMjAlMjAlMjAlMjB0aGlzLnNleCUyMCUzRCUyMHNleCUzQiU1Q24lMjAlMjAlN0QlNUNuJTVDbiUyMCUyMF9jcmVhdGVDbGFzcyhQZXJzb24lMkMlMjAlNUIlN0IlNUNuJTIwJTIwJTIwJTIwa2V5JTNBJTIwJ2dldE5hbWUnJTJDJTVDbiUyMCUyMCUyMCUyMHZhbHVlJTNBJTIwZnVuY3Rpb24lMjBnZXROYW1lKCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwJTIwJTIwcmV0dXJuJTIwdGhpcy5uYW1lJTNCJTVDbiUyMCUyMCUyMCUyMCU3RCU1Q24lMjAlMjAlN0QlNUQpJTNCJTVDbiU1Q24lMjAlMjByZXR1cm4lMjBQZXJzb24lM0IlNUNuJTdEKCklM0IlNUNudmFyJTIwQXBwbGUlMjAlM0QlMjBmdW5jdGlvbiUyMCgpJTIwJTdCJTVDbiUyMCUyMGZ1bmN0aW9uJTIwQXBwbGUoX3JlZjIpJTIwJTdCJTVDbiUyMCUyMCUyMCUyMHZhciUyMG1vZGVsJTIwJTNEJTIwX3JlZjIubW9kZWwlM0IlNUNuJTVDbiUyMCUyMCUyMCUyMF9jbGFzc0NhbGxDaGVjayh0aGlzJTJDJTIwQXBwbGUpJTNCJTVDbiU1Q24lMjAlMjAlMjAlMjB0aGlzLmNsYXNzTmFtZSUyMCUzRCUyMCdBcHBsZSclM0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5tb2RlbCUyMCUzRCUyMG1vZGVsJTNCJTVDbiUyMCUyMCU3RCU1Q24lNUNuJTIwJTIwX2NyZWF0ZUNsYXNzKEFwcGxlJTJDJTIwJTVCJTdCJTVDbiUyMCUyMCUyMCUyMGtleSUzQSUyMCdnZXRNb2RlbCclMkMlNUNuJTIwJTIwJTIwJTIwdmFsdWUlM0ElMjBmdW5jdGlvbiUyMGdldE1vZGVsKCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwJTIwJTIwcmV0dXJuJTIwdGhpcy5tb2RlbCUzQiU1Q24lMjAlMjAlMjAlMjAlN0QlNUNuJTIwJTIwJTdEJTVEKSUzQiU1Q24lNUNuJTIwJTIwcmV0dXJuJTIwQXBwbGUlM0IlNUNuJTdEKCklM0IlNUNuJTVDbmV4cG9ydCUyMCU3QiUyMFBlcnNvbiUyQyUyMEFwcGxlJTIwJTdEJTNCJTVDbiUyMiU3RCU1RCUyQyUyMm9wdGlvbnMlMjIlM0ElN0IlMjJmb3JtYXQlMjIlM0ElMjJlcyUyMiUyQyUyMm1vZHVsZU5hbWUlMjIlM0ElMjJteUJ1bmRsZSUyMiUyQyUyMmdsb2JhbHMlMjIlM0ElN0IlN0QlMkMlMjJuYW1lJTIyJTNBJTIybXlCdW5kbGUlMjIlMkMlMjJhbWQlMjIlM0ElN0IlMjJpZCUyMiUzQSUyMiUyMiU3RCU3RCUyQyUyMmV4YW1wbGUlMjIlM0FudWxsJTdE)


babel宽松模式之后的 treeShaking [传送门](https://rollupjs.cn/repl?version=0.53.3&shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMEFwcGxlJTIwJTdEJTIwZnJvbSUyMCcuJTJGY29tcG9uZW50cyclNUNuJTVDbmNvbnN0JTIwYXBwbGVNb2RlbCUyMCUzRCUyMG5ldyUyMEFwcGxlKCU3QiU1Q24lMjAlMjBtb2RlbCUzQSUyMCdJcGhvbmVYJyU1Q24lN0QpLmdldE1vZGVsKCklNUNuJTVDbmNvbnNvbGUubG9nKGFwcGxlTW9kZWwpJTIyJTdEJTJDJTdCJTIybmFtZSUyMiUzQSUyMmNvbXBvbmVudHMuanMlMjIlMkMlMjJjb2RlJTIyJTNBJTIyJ3VzZSUyMHN0cmljdCclM0IlNUNuJTVDbmZ1bmN0aW9uJTIwX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlJTJDJTIwQ29uc3RydWN0b3IpJTIwJTdCJTIwaWYlMjAoIShpbnN0YW5jZSUyMGluc3RhbmNlb2YlMjBDb25zdHJ1Y3RvcikpJTIwJTdCJTIwdGhyb3clMjBuZXclMjBUeXBlRXJyb3IoJTVDJTIyQ2Fubm90JTIwY2FsbCUyMGElMjBjbGFzcyUyMGFzJTIwYSUyMGZ1bmN0aW9uJTVDJTIyKSUzQiUyMCU3RCUyMCU3RCU1Q24lNUNudmFyJTIwUGVyc29uJTIwJTNEJTIwZnVuY3Rpb24lMjAoKSUyMCU3QiU1Q24lMjAlMjBmdW5jdGlvbiUyMFBlcnNvbihfcmVmKSUyMCU3QiU1Q24lMjAlMjAlMjAlMjB2YXIlMjBuYW1lJTIwJTNEJTIwX3JlZi5uYW1lJTJDJTVDbiUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGFnZSUyMCUzRCUyMF9yZWYuYWdlJTJDJTVDbiUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNleCUyMCUzRCUyMF9yZWYuc2V4JTNCJTVDbiU1Q24lMjAlMjAlMjAlMjBfY2xhc3NDYWxsQ2hlY2sodGhpcyUyQyUyMFBlcnNvbiklM0IlNUNuJTVDbiUyMCUyMCUyMCUyMHRoaXMuY2xhc3NOYW1lJTIwJTNEJTIwJ1BlcnNvbiclM0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5uYW1lJTIwJTNEJTIwbmFtZSUzQiU1Q24lMjAlMjAlMjAlMjB0aGlzLmFnZSUyMCUzRCUyMGFnZSUzQiU1Q24lMjAlMjAlMjAlMjB0aGlzLnNleCUyMCUzRCUyMHNleCUzQiU1Q24lMjAlMjAlN0QlNUNuJTVDbiUyMCUyMFBlcnNvbi5wcm90b3R5cGUuZ2V0TmFtZSUyMCUzRCUyMGZ1bmN0aW9uJTIwZ2V0TmFtZSgpJTIwJTdCJTVDbiUyMCUyMCUyMCUyMHJldHVybiUyMHRoaXMubmFtZSUzQiU1Q24lMjAlMjAlN0QlM0IlNUNuJTVDbiUyMCUyMHJldHVybiUyMFBlcnNvbiUzQiU1Q24lN0QoKSUzQiU1Q24lNUNudmFyJTIwQXBwbGUlMjAlM0QlMjBmdW5jdGlvbiUyMCgpJTIwJTdCJTVDbiUyMCUyMGZ1bmN0aW9uJTIwQXBwbGUoX3JlZjIpJTIwJTdCJTVDbiUyMCUyMCUyMCUyMHZhciUyMG1vZGVsJTIwJTNEJTIwX3JlZjIubW9kZWwlM0IlNUNuJTVDbiUyMCUyMCUyMCUyMF9jbGFzc0NhbGxDaGVjayh0aGlzJTJDJTIwQXBwbGUpJTNCJTVDbiU1Q24lMjAlMjAlMjAlMjB0aGlzLmNsYXNzTmFtZSUyMCUzRCUyMCdBcHBsZSclM0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5tb2RlbCUyMCUzRCUyMG1vZGVsJTNCJTVDbiUyMCUyMCU3RCU1Q24lNUNuJTIwJTIwQXBwbGUucHJvdG90eXBlLmdldE1vZGVsJTIwJTNEJTIwZnVuY3Rpb24lMjBnZXRNb2RlbCgpJTIwJTdCJTVDbiUyMCUyMCUyMCUyMHJldHVybiUyMHRoaXMubW9kZWwlM0IlNUNuJTIwJTIwJTdEJTNCJTVDbiU1Q24lMjAlMjByZXR1cm4lMjBBcHBsZSUzQiU1Q24lN0QoKSUzQiU1Q24lNUNuZXhwb3J0JTIwJTdCJTIwUGVyc29uJTJDJTIwQXBwbGUlMjAlN0QlM0IlNUNuJTIyJTdEJTVEJTJDJTIyb3B0aW9ucyUyMiUzQSU3QiUyMmZvcm1hdCUyMiUzQSUyMmVzJTIyJTJDJTIybW9kdWxlTmFtZSUyMiUzQSUyMm15QnVuZGxlJTIyJTJDJTIyZ2xvYmFscyUyMiUzQSU3QiU3RCUyQyUyMm5hbWUlMjIlM0ElMjJteUJ1bmRsZSUyMiUyQyUyMmFtZCUyMiUzQSU3QiUyMmlkJTIyJTNBJTIyJTIyJTdEJTdEJTJDJTIyZXhhbXBsZSUyMiUzQW51bGwlN0Q=)


引用类型的副作用 [传送门](https://rollupjs.cn/repl?version=0.53.3&shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMGN1YmUlMjAlN0QlMjBmcm9tJTIwJy4lMkZtYXRocy5qcyclM0IlNUNuY29uc29sZS5sb2coJTIwY3ViZSglMjA1JTIwKSUyMCklM0IlMjAlMkYlMkYlMjAxMjUlMjIlN0QlMkMlN0IlMjJuYW1lJTIyJTNBJTIybWF0aHMuanMlMjIlMkMlMjJjb2RlJTIyJTNBJTIyJTJGJTJGJTIwVGhpcyUyMGZ1bmN0aW9uJTIwaXNuJ3QlMjB1c2VkJTIwYW55d2hlcmUlMkMlMjBzbyU1Q24lMkYlMkYlMjBSb2xsdXAlMjBleGNsdWRlcyUyMGl0JTIwZnJvbSUyMHRoZSUyMGJ1bmRsZS4uLiU1Q25leHBvcnQlMjBmdW5jdGlvbiUyMHNxdWFyZSUyMCglMjB4JTIwKSUyMCU3QiU1Q24lNUN0cmV0dXJuJTIweC5hJTNCJTVDbiU3RCU1Q24lNUNuc3F1YXJlKCU3QmElM0ExJTdEKSUzQiU1Q24lNUNuJTJGJTJGJTIwVGhpcyUyMGZ1bmN0aW9uJTIwZ2V0cyUyMGluY2x1ZGVkJTVDbmV4cG9ydCUyMGZ1bmN0aW9uJTIwY3ViZSUyMCglMjB4JTIwKSUyMCU3QiU1Q24lNUN0JTJGJTJGJTIwcmV3cml0ZSUyMHRoaXMlMjBhcyUyMCU2MHNxdWFyZSglMjB4JTIwKSUyMColMjB4JTYwJTVDbiU1Q3QlMkYlMkYlMjBhbmQlMjBzZWUlMjB3aGF0JTIwaGFwcGVucyElNUNuJTVDdHJldHVybiUyMHglMjAqJTIweCUyMColMjB4JTNCJTVDbiU3RCUyMiU3RCU1RCUyQyUyMm9wdGlvbnMlMjIlM0ElN0IlMjJmb3JtYXQlMjIlM0ElMjJlcyUyMiUyQyUyMm1vZHVsZU5hbWUlMjIlM0ElMjJteUJ1bmRsZSUyMiUyQyUyMmdsb2JhbHMlMjIlM0ElN0IlN0QlMkMlMjJuYW1lJTIyJTNBJTIybXlCdW5kbGUlMjIlMkMlMjJhbWQlMjIlM0ElN0IlMjJpZCUyMiUzQSUyMiUyMiU3RCU3RCUyQyUyMmV4YW1wbGUlMjIlM0FudWxsJTdE)